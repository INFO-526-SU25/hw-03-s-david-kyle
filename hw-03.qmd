---
title: "HW 03"
author: "Seldon David Kyle"
format:
  html:
    embed-resources: true
toc: true
execute:
  warning: false
  error: false
  message: false
---

```{r}
#| label: load-pkgs
#| message: false
#| echo: false

if (!require("pacman")) 
  install.packages("pacman")

pacman::p_load(tidyverse,
               patchwork               )
```

## 1 - Du Bois challenge.

```{r}
income <- read_csv("data/income.csv")

```

```{r}

# Recode final class label for line break
income <- income |>
  mutate(
    Class = recode(Class, "$1000 AND OVER" = "$1000\nAND OVER")
  )

# left table
label_table <- income |>
  mutate(
    Class = factor(Class, levels = rev(c(
      "$100-200", "$200-300", "$300-400", "$400-500",
      "$500-750", "$750-1000", "$1000\nAND OVER"
    ))),
    row = as.numeric(Class)
  ) |>
  ggplot(aes(y = Class)) +
  geom_tile(aes(x = 1.5, width = 2, height = 1), fill = NA, color = "black") +
  geom_segment(
    data = tibble(y = seq(0.5, 7.5, 1)),
    aes(x = 0.9, xend = 2.9, y = y, yend = y),
    inherit.aes = FALSE,
    color = "gray70", linewidth = 0.2
  ) +
  geom_segment(
    data = tibble(x = c(0.9, 1.95, 2.9)),
    aes(x = x, xend = x, y = 0.5, yend = 7.5),
    inherit.aes = FALSE,
    color = "gray70", linewidth = 0.2
  ) +
  geom_text(aes(x = 1, label = Class), hjust = 0, size = 3.2, fontface = "bold", family = "mono") +
  geom_text(aes(x = 2, label = paste0("$", Average_Income)), hjust = 0, size = 3.2, family = "mono") +
  scale_y_discrete(limits = rev(c(
    "$100-200", "$200-300", "$300-400", "$400-500",
    "$500-750", "$750-1000", "$1000\nAND OVER"
  ))) +
  xlim(0.9, 2.9) +
  labs(title = NULL, x = NULL, y = NULL) +
  theme_void() +
  theme(
    plot.margin = margin(5, 0, 5, 5),
    axis.text.y = element_blank(),
    plot.background = element_rect(fill = "#f3eacb", color = NA)
  )

# bar chart
data_long <- income |>
  pivot_longer(cols = Rent:Other, names_to = "type", values_to = "measurement") |>
  mutate(
    type = factor(type, levels = c("Rent", "Food", "Clothes", "Tax", "Other")),
    Class = factor(Class, levels = rev(c(
      "$100-200", "$200-300", "$300-400", "$400-500",
      "$500-750", "$750-1000", "$1000\nAND OVER"
    )))
  )

data_long$measurement[data_long$measurement == 0] <- 0.1

category_colors <- c(
  Rent = "black",
  Food = "mediumorchid4",
  Clothes = "lightsalmon1",
  Tax = "slategray3",
  Other = "gray75"
)

bar_plot <- ggplot(data_long, aes(x = Class, y = measurement, fill = type)) +
  geom_bar(stat = "identity", width = 0.8) +
  geom_text(
    aes(label = ifelse(measurement >= 1, paste0(measurement, "%"), "")),
    position = position_stack(vjust = 0.5),
    size = 3,
    color = "white"
  ) +
  scale_y_reverse() +
  scale_fill_manual(values = category_colors) +
  coord_flip() +
  labs(
    title = "INCOME AND EXPENDITURE OF 150 BLACK FAMILIES",
    subtitle = "Simplified Du Bois Reproduction",
    x = NULL, y = "FOR FURTHER STATISTICS RAISE THIS FRAME"
  ) +
  theme_minimal(base_size = 12) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0, size = 12),
    axis.text.y = element_blank(),
    axis.text.x = element_blank(),
    axis.ticks.x = element_blank(),
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_blank(),
    legend.title = element_blank(),
    legend.position = "top",
    legend.direction = "horizontal",
    legend.justification = "center",
    plot.background = element_rect(fill = "#f3eacb", color = NA)
  )

# Combine and apply background to whole figure
(label_table + bar_plot + plot_layout(widths = c(1.3, 3))) & 
  theme(plot.background = element_rect(fill = "#f3eacb", color = NA))


```

## 2 - COVID survey - interpret

This plot compares medical and nursing students’ responses to a series of statements about the COVID-19 vaccine. Responses are broken down by demographic and professional groups and displayed as a faceted Likert mean plot. Each point represents the mean Likert score for a subgroup, with error bars spanning the 10th to 90th percentile to show response variability.

#### Directionality of Agreement by Statement

Out of the six statements students responded to, five are positively framed. "I believe the vaccine is safe," strong agreement–score lower–means pro-belief in the vaccine. However, "I am concerned about the safety and side effects of the vaccine" is negatively framed–score lower means high concern.

With the exception of side effects, these questions are *almost* the same so you would think they have the same, but flipped, scores. The error bars appear to be the same, but the mean of the positive statement is agreed upon much more than the negative sentiment is disagreed with.

There are a few reasons this may be occurring; I'll mention two. First, agreeing with safety may be easier than disagreeing with concern, especially for people training in healthcare, where some level of risk is more accepted. Second, it’s just a survey, and disagreeing with a negatively worded statement requires more cognitive effort than simply agreeing with a positively framed one. Understanding that you’re rejecting a negative takes more mental processing than offering straightforward agreement.

#### Vaccinated vs. Unvaccinated Respondents

Across all response statements, students who reported being vaccinated show markedly more favorable attitudes toward the COVID-19 vaccine than those who were unvaccinated. With the exception of statements one and three, vaccinated students not only had more favorable mean scores, but also considerably less variance, as shown by the shorter error bars.

Whether students got vaccinated because they held favorable views, or developed those views after getting vaccinated, is not entirely clear. Likely, it’s a bit of both. What does seem clear is that vaccination experience reinforces advocacy: among vaccinated students, the mean response is nearly perfectly favorable—with very little variation across individuals.

#### Flu Vaccination as a Marker of Vaccine Trust

Students who received the flu vaccine gave more favorable responses to the survey’s trust-related statements. Excluding statements one and three, they also showed noticeably less variance in their responses. This supports the idea that individuals who receive vaccines tend to have a general trust in vaccines and the approval process—whether or not they fully understand the details of that process.

As with previous examples, the causal relationship is unclear: do students trust vaccines and therefore choose to get vaccinated, or does the act of vaccination reinforce their trust? Further statistical testing would be needed to determine whether the same individuals make up both the flu and COVID vaccination cohorts.

## 3 - COVID survey - reconstruct

```{r}

survey <- read_csv("data/covid-survey.csv", skip = 1)
```

```{r}

dim(survey)

```

```{r}

survey_clean <- survey |>
  filter(!if_all(-response_id, is.na))

dim(survey_clean)
```

```{r}
library(dplyr)

survey_labeled <- survey_clean |>
  mutate(
    exp_already_vax = recode(exp_already_vax,
      `0` = "No", `1` = "Yes"
    ),
    exp_flu_vax = recode(exp_flu_vax,
      `0` = "No", `1` = "Yes"
    ),
    exp_profession = recode(exp_profession,
      `0` = "Medical", `1` = "Nursing"
    ),
    exp_gender = recode(exp_gender,
      `0` = "Male",
      `1` = "Female",
      `3` = "Non-binary / Third gender",
      `4` = "Prefer not to say"
    ),
    exp_race = recode(exp_race,
      `1` = "American Indian / Alaskan Native",
      `2` = "Asian",
      `3` = "Black / African American",
      `4` = "Native Hawaiian / Other Pacific Islander",
      `5` = "White"
    ),
    exp_ethnicity = recode(exp_ethnicity,
      `1` = "Hispanic / Latino",
      `2` = "Non-Hispanic / Non-Latino"
    ),
    exp_age_bin = recode(exp_age_bin,
      `0` = "<20",
      `20` = "21–25",
      `25` = "26–30",
      `30` = ">30"
    )
  )

```

```{r}

dim(survey_labeled)
```

```{r}

covid_survey_longer <- survey_labeled |>
  pivot_longer(
    cols = starts_with("exp_"),
    names_to = "explanatory",
    values_to = "explanatory_value"
  ) |>
  filter(!is.na(explanatory_value)) |>
  pivot_longer(
    cols = starts_with("resp_"),
    names_to = "response",
    values_to = "response_value"
  )


```

The first pivot_longer reshapes the data from wide to long. All columns that begin with "exp\_" are turned into two columns, "explanatory" that holds the name of the variable and "explanatory_value" holds the actual value for that column.

The second is also reshaping from wide to long. This time all columns that begin with "resp\_" are turned into two columns, "response" which is the name of the response question and "response_value" with the corresponding score.

```{r}

covid_survey_longer

```

```{r}
covid_survey_summary_stats_by_group <- covid_survey_longer |>
  group_by(explanatory, explanatory_value, response) |>
  summarize(
    mean = mean(response_value, na.rm = TRUE),
    low  = quantile(response_value, 0.10, na.rm = TRUE),
    high = quantile(response_value, 0.90, na.rm = TRUE),
    .groups = "drop"
  )

covid_survey_summary_stats_by_group
```

```{r}
covid_survey_summary_stats_all <- covid_survey_longer |>
  group_by(response) |>
  summarize(
    mean = mean(response_value, na.rm = TRUE),
    low  = quantile(response_value, 0.10, na.rm = TRUE),
    high = quantile(response_value, 0.90, na.rm = TRUE),
    explanatory = "All",
    explanatory_value = factor(""),
    .groups = "drop"
  )


covid_survey_summary_stats_all
```

```{r}
covid_survey_summary_stats <- bind_rows(
  covid_survey_summary_stats_all,
  covid_survey_summary_stats_by_group
)

covid_survey_summary_stats2 <- covid_survey_summary_stats

covid_survey_summary_stats |> glimpse()


```

```{r}
#| fig-width: 9
#| fig-height: 8

response_labels <- c(
  resp_safety              = "Based on my\nunderstanding,I\nbelieve the\nvaccine is safe",
  resp_confidence_science  = "I am confident\nin the scientific\nvetting process\n for the new\nCOVID vaccines",
  resp_feel_safe_at_work   = "Getting the vaccine\nwil lmake me feel\nsafer at work",
  resp_will_recommend      = "I will recommend\nthe vaccine to\nfamily, friends,\n and community\nmembers",
  resp_trust_info          = "I trust the\ninformation that I\nhave received\nabout the\nvaccines",
  resp_concern_safety      = "I am concerned\nabout the safety\nand side effects\nof the vaccine"
)

covid_survey_summary_stats <- covid_survey_summary_stats |>
  mutate(response = factor(response, levels = c(
    "resp_safety",
    "resp_feel_safe_at_work",
    "resp_concern_safety",
    "resp_confidence_science",
    
    "resp_trust_info",
    "resp_will_recommend"
  )))

explanatory_labels <- c(
  exp_age_bin       = "Age",
  exp_gender        = "Gender",
  exp_race          = "Race",
  exp_ethnicity     = "Ethnicity",
  exp_profession    = "Profession",
  exp_already_vax   = "Had COVID\nvaccine",
  exp_flu_vax       = "Had flu\nvaccine this\nyear",
  All               = "All"
)


covid_survey_summary_stats <- covid_survey_summary_stats |>
  mutate(
    explanatory = fct_relevel(
      explanatory,
      "All",
      "exp_age_bin",
      "exp_gender",
      "exp_race",
      "exp_ethnicity",
      "exp_profession",
      "exp_already_vax",
      "exp_flu_vax"
      
    )
  )


covid_survey_summary_stats <- covid_survey_summary_stats |>
  filter(
    explanatory == "All" |
    (explanatory == "exp_age_bin"     & explanatory_value %in% c("<20", "21–25", "26–30", ">30")) |
    (explanatory == "exp_gender"      & explanatory_value %in% c("Male", "Female", "Non-binary / Third gender", "Prefer not to say")) |
    (explanatory == "exp_race"        & explanatory_value %in% c(
      "American Indian / Alaskan Native", "Asian", "Black / African American",
      "Native Hawaiian / Other Pacific Islander", "White")) |
    (explanatory == "exp_ethnicity"   & explanatory_value %in% c("Hispanic / Latino", "Non-Hispanic / Non-Latino")) |
    (explanatory == "exp_profession"  & explanatory_value %in% c("Medical", "Nursing")) |
    (explanatory == "exp_already_vax" & explanatory_value %in% c("Yes", "No")) |
    (explanatory == "exp_flu_vax"     & explanatory_value %in% c("Yes", "No"))
  )


covid_survey_summary_stats <- covid_survey_summary_stats |>
  group_by(explanatory) |>
  mutate(
    explanatory_value = case_when(
      explanatory == "exp_age_bin" ~ factor(explanatory_value, levels = c(
        ">30", "26–30", "21–25", "<20")),
      explanatory == "exp_gender" ~ factor(explanatory_value, levels = c(
        "Prefer not to say", "Non-binary / Third gender", "Male", "Female" )),
      explanatory == "exp_race" ~ factor(explanatory_value, levels = c(
        "White",
        "Native Hawaiian / Other Pacific Islander",
        "Black / African American",
        "Asian",
        "American Indian / Alaskan Native"
      )),
      explanatory == "exp_ethnicity" ~ factor(explanatory_value, levels = c(
        "Non-Hispanic / Non-Latino", "Hispanic / Latino")),
      explanatory == "exp_profession" ~ factor(explanatory_value, levels = c( "Nursing","Medical")),
      explanatory == "exp_already_vax" ~ factor(explanatory_value, levels = c("Yes", "No")),
      explanatory == "exp_flu_vax" ~ factor(explanatory_value, levels = c("Yes", "No")),
      TRUE ~ factor(explanatory_value)
    )
  ) |>
  ungroup()


ggplot(covid_survey_summary_stats, aes(y = fct_rev(explanatory_value), x = mean)) +
  geom_point() +
  geom_errorbarh(aes(xmin = low, xmax = high), height = 0.2) +
  facet_grid(
    rows = vars(explanatory),
    cols = vars(response),
    scales = "free_y",
    labeller = labeller(
      response = response_labels,
      explanatory = explanatory_labels
    ),
    drop = TRUE
  ) +
  scale_x_continuous(breaks = 1:5, limits = c(1, 5)) +
  theme_minimal() +
  theme(
    strip.background = element_rect(fill = "gray90", color = NA),
    strip.text.y = element_text(size = 8, angle = 0),  # smaller font, taller strips
    strip.text.x = element_text(size = 8, margin = margin(t = 10, b = 10)),
    axis.text.y = element_text(size = 8),
    axis.text.x = element_text(size = 8),
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  ) +
  labs(
    x = "Mean Likert Score\n(Error bars range from 10th to 90th percentile)",
    y = NULL,
    title =NULL
  )


```

```{r}

```

```{r}

# define scoped factor levels
explanatory_levels <- list(
  exp_age_bin     = c("<20", "21–25", "26–30", ">30"),
  exp_gender      = c("Male", "Female", "Non-binary / Third gender", "Prefer not to say"),
  exp_race        = c("American Indian / Alaskan Native", "Asian", "Black / African American",
                      "Native Hawaiian / Other Pacific Islander", "White"),
  exp_ethnicity   = c("Hispanic / Latino", "Non-Hispanic / Non-Latino"),
  exp_profession  = c("Medical", "Nursing"),
  exp_already_vax = c("Yes", "No"),
  exp_flu_vax     = c("Yes", "No")
)

# apply scoped factor conversion
covid_cleaned <- covid_survey_summary_stats2 |>
  mutate(explanatory_value = as.character(explanatory_value)) |>
  group_by(explanatory) |>
  mutate(
    explanatory_value = if (explanatory[1] %in% names(explanatory_levels)) {
      factor(explanatory_value, levels = explanatory_levels[[explanatory[1]]])
    } else {
      factor(explanatory_value)
    }
  ) |>
  ungroup()

all_df <- covid_survey_summary_stats |>
  filter(explanatory == "All") |>
  mutate(explanatory_value = factor(as.character(explanatory_value)))

covid_cleaned <- bind_rows(covid_cleaned, all_df)

# let's just test and pray
explanatory_groups <- names(explanatory_levels)

for (group in explanatory_groups) {
  cat("\n---", group, "---\n")
  print(
    covid_cleaned |>
      filter(explanatory == group) |>
      droplevels() |>
      pull(explanatory_value) |>
      levels()
  )
}

covid_cleaned |>
  count(explanatory) |>
  print(n = Inf)

```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

```{r}
```

## 4 - COVID survey - re-reconstruct

## 5 - COVID survey - another view
